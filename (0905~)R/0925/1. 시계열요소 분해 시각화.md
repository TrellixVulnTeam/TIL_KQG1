# 시계열분석

## 1.시계열요소 분해 시각화

>  시계열요소분해를 통해서 만들어진 그래프를 대상으로 분석하는 자체를 시계열 분석 기법에 포함한다. 

>  시계열요소분해 시각화는 시계열 자료를 이해하는 데 도움을 제공할 뿐만 아니라 시계열 자료를 분석하는 데 중요한 역할을 제공한다.

- **stl()** 함수는 하나의 시계열 자료를 대상으로 시계열 변동요인인 계절요소(seasonal), 추세(trend), 잔차(remainder)를 모두 제공해준다. 
- 시계열의 변동요인을 분석하여 시계열 모형을 선정하는데 유용한 역할을 제공한다
- **decompse()** – 시계열 분해

### 1.1 시계열 자료의 변동요인  

- 추세 변동(Trend variation: T) – 인구 변동, 지각변동, 기술변화 등으로 인하여 상승과 하락의 영향을 받아 시계열 자료에 영향을 주는 장기 변동 요인

- 순환 변동(Cyclical variation: C) – 2년 ~ 10년의 주기에서 일정한 기간 없이 반복적인 요소를 가지는 중.장기 변동 요인

- 계절 변동(Seasonal variation: S) – 일정한 기간(월, 요일, 분기 등)에 의해서 1년을 단위로 반복적인 요소를 가지는 단기 변동 요인

- 불규칙변동(Irregular variation: I) – 어떤 규칙 없이 예측 불가능한 변동요인으로 추세, 순환, 계절요인으로 설명할 수 없는 요인 (실제 시계열 자료에서 추세, 순환, 계절요인을 뺀 결과로 나타난다. – 회귀분석에서 오차에 해당)

  

```R
> ##########시계열요소 분해 시각화 ########################
> data <- c(45, 56, 45, 43, 69, 75, 58, 59, 66, 64, 62, 65, 
+           55, 49, 67, 55, 71, 78, 71, 65, 69, 43, 70, 75, 
+           56, 56, 65, 55, 82, 85, 75, 77, 77, 69, 79, 89)
> length(data)# 36
[1] 36

> # 시계열자료 생성 : 시계열자료 형식으로 객체 생성
> tsdata <- ts(data, start=c(2016, 1), frequency=12) 

> tsdata    # 2016~2018
     Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
2016  45  56  45  43  69  75  58  59  66  64  62  65
2017  55  49  67  55  71  78  71  65  69  43  70  75
2018  56  56  65  55  82  85  75  77  77  69  79  89

> # 추세선 확인 
> par(mfrow=c(1,1))

> ts.plot(tsdata)  #각 요인(추세, 순환, 계절, 불규칙)을 시각적 확인   

> plot(stl(tsdata, "periodic"))  #주기적

> #잔차는 회귀식에 의해 추정된 값과 실제 값의 차이 - 계절과 추세 적합 결과에 의해서 나타남
> #시계열분해, 변동요인 제거
> m<-decompose(tsdata)
> attributes(m)   
$names
[1] "x"        "seasonal" "trend"    "random"  
[5] "figure"   "type"    

$class
[1] "decomposed.ts"

> plot(m) #추세, 계절, 불규칙 요인 포함 시각화
> plot(tsdata - m$seasonal)   #계절요인 제거
> plot(tsdata - m$trend)
> plot(tsdata - m$seasonal-m$trend) #불규칙 요인만 시각화
```

### 1.2자기 상관 함수 / 부분 자기 상관 함수  

> 자기 상관성은 자기 상관계수가 유의미한가를 나타내는 특성이다.

>  자기 상관계수 - 시계열 자료(Yt)에서 시차(lag)를 일정하게 주는 경우 얻어지는 상관계수이다.

- 예) 시차 1의 자기 상관계수는 Yt와 Yt-1 간의 상관계수를 의미한다.
- 자기 상관계수는 서로 이웃한 시점 간의 상관계수를 찾는 데 이용된다.

> 부분 자기 상관계수 -  다른 시차들의 시계열 자료가 미치는 영향을 제거한 후에 주어진 시차에 대한 시계열 간의 상관계수이다.

- 자기 상관 함수와 부분 자기 상관 함수는 시계열의 모형을 식별하는 수단으로 이용된다.

- 자기 상관 함수 / 부분 자기 상관 함수  시각화 = **packf()** 

  

```R
> input <- c(3180,3000,3200,3100,3300,3200,3400,3550,3200,3400,3300,3700)    
> #시계열 객체 생성(12개월 : 2015년 2월 ~ 2016년 1개)
> tsdata<-ts(input,start=c(2015,2),frequency=12)
> tsdata
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct
2015      3180 3000 3200 3100 3300 3200 3400 3550 3200
2016 3700                                             
      Nov  Dec
2015 3400 3300
2016          
> #추세선 시각화 
> plot(tsdata,type="l",col='red')
> #자기상관함수 시각화
> acf(na.omit(tsdata),main="자기상관함수",col="red")
> #부분 자기 상관 함수 시각화
> pacf(na.omit(tsdata), main="부분자기상관함수", col="red")
```

### 1.3 추세패턴 시각화

- 추세 패턴 – 시계열 자료가 증가 또는 감소하는 경향이 있는지 알아보고, 증가나 감소의 경향이 선형(Linear)인지 비선형(non-Linear)인지를 찾는 과정
- 추세 패턴의 객관적인 근거는 차분(Differencing)과 자기 상관성(Autocorrelation)을 통해서 얻을 수 있는데 여기서 차분은 현재 시점에서 이전 시점의 자료를 빼는 연산을 의미한다.

```R
> input <- c(3180,3000,3200,3100,3300,3200,3400,3550,3200,3400,3300,3700) 
> 
> #시계열 객체 생성(12개월 : 2015년 2월 ~ 2016년 1개)
> tsdata<-ts(input,start=c(2015,2),frequency=12)
> tsdata
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct
2015      3180 3000 3200 3100 3300 3200 3400 3550 3200
2016 3700                                             
      Nov  Dec
2015 3400 3300
2016          
> 
> #추세선 시각화 
> plot(tsdata,type="l",col='red')  #점진적으로 증가하는 추세의 선형 형태 확인


> #자기상관함수 시각화
> acf(na.omit(tsdata),main="자기상관함수",col="red") #자기 상관성 없음

> #차분 시각화
> plot(diff(tsdata,differences=1)) #평균을 중심으로 일정한 폭을 나타내고 있음

#결론 : 추세의 패턴은 선형으로 판단됨
```

## 2. 시계열분석 기법

### 2.1 평활법(Smothing Method)  

> 시계열 자료의 체계적인 자료의 흐름을 파악하기 위해서 과거 자료의 불규칙적인 변동을 제거하는 방법

> 시계열 자료의 뾰족한 작은 변동들을 제거하여 부드러운 곡선으로 시계열 자료를 조정하는 기법

- 이동평균, 지수평활법 

#### 2.1.1 이동평균(Moving Average)  

> 시계열 자료를 대상으로 일정한 기간의 자료를 평균으로 계산하고, 이동시킨 추세를 파악하여 다음 기간의 추세를 예측하는 방법

- 시계열 자료에서 계절 변동과 불규치변동을 제거하여 추세 변동과 순환 변동만 갖는 시계열로 변환한다(시계열에서 추세와 순환예측)
- 자료의 수가 많고 비교적 안정적 패턴을 보이는 경우 효과적이다
- TTR::SMA() – 이동평균번으로 평활하는 함수
- 가장 평탄한 형태로 분포된 결과를 선정하여 추세를 예측하는데 사용된다

### 2.2 회귀분석법  

- 시계열 자료는 시간이라는 설명변수(독립변수)에 의해서 어떤 반응변수(종속변수)를 나타내는 것을 말한다.
  예) 매분 매시간 단위로 주식 시세의 데이터가 기록되는 경우, 매분, 매시간은 반응변수이고, 주식 시세의 값은 설명변수에 해당한다.
- 선형회귀 분석을 이용하여 시계열 자료의 선형성이나 정규성, 등분산성 등의 모수검정을 위한 타당성을 검정해야 한다

### 2.3 ARIMA  모형  

#### 2.3.1 ARIMA  모형  시계열 자료 처리 절차

- 식별(Identification) – ARIMA의 **3개의 차수  (p, d, q)를 결정**하는 단계, 현재 시계열 자료가 어떤 모형(AR, MA, ARMA)에 해당하는가를 판단하는 단계, 식별의 수단으로 자기 상관 함수**(acf)**와 부분 자기 상관 함수**(pacf)**를 이용
- 추정(Estimation) – 식별된 모형의 **파라미터를 추정**하는 단계, 최소제곱법을 이용
- 진단(Diagnosis) – 모형식별과 파라미터 추정에 의해서 생성된 모형이 적합한지를 검증하는 단계, 적합성 검증의 수단으로 잔차가 백색 잡음(white noise)인지를 살펴보고, 백색 잡음과 차이가 없으면 적합하다고 할 수 있다

#### 2.3.2 ARIMA 모형 시계열 예측 - ARIMA  모형 분석 절차 

단계 1] 시계열 자료 특성분석(정상성/비정상성)

단계 2] 정상성 시계열 반환

단계 3] 모형 식별과 추정  - forecast::auto.arima() 

단계 4] 모형 생성

단계 5] 모형 진단(모형 타당성 검정) -  자기 상관 함수의 결과가 유의미한 시차가 없는 경우, 오차 간에 상관관계가 존재하는지를 검정하는 방법인 Box-Ljung 검정에서 p 값이 0.05 이상인 경우

단계 6] 미래 예측(업무 적용)

- **tsdiag(model)** – 자기 상관 함수에 의한 모형 진단
- **Box.test()** – 잔차항 모형 진단, 모형의 잔차를 이용하여 카이제곱검정 방법으로 시계열 모형이 통계적으로 적절한지를 검정하는 방법으로 p-value가 0.05이상이면 모형이 통계적으로 적절하다고 볼 수 있다 
- **forecast:: forecast()** – 시계열의 예측치를 제공하는 함수

```R
> ########정상성 시계열의 ARIMA 모델 분석###########
> input <- c(3180,3000,3200,3100,3300,3200,3400,3550,3200,3400,3300,3700) 
> #시계열 객체 생성(12개월 : 2015년 2월 ~ 2016년 1개)
> tsdata<-ts(input,start=c(2015,2),frequency=12)
> 
> tsdata
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct
2015      3180 3000 3200 3100 3300 3200 3400 3550 3200
2016 3700                                             
      Nov  Dec
2015 3400 3300
2016          
> # 추세선 시각화
> plot(tsdata, type="l", col='red')

> # 정상성시계열 변환
> par(mfrow=c(1,2))
> diff <- diff(tsdata)
> ts.plot(tsdata)
> diff <- diff(tsdata)
> plot(diff) # 차분 : 현시점에서 이전시점의 자료를 빼는 연산

> # auto.arima() : 시계열 모형을 식별하는 알고리즘에 의해서 최적의 모형과 파라미터를 추정하여 제공
> install.packages('forecast')
> library(forecast)
Registered S3 method overwritten by 'quantmod':
  method            from
  as.zoo.data.frame zoo 
Registered S3 methods overwritten by 'forecast':
  method             from    
  fitted.fracdiff    fracdiff
  residuals.fracdiff fracdiff
> arima <- auto.arima(tsdata) # 시계열 데이터 이용 
> arima
Series: tsdata 

ARIMA(1,1,0)  #자기 회귀 모형 차수 1, 차분차수 1
#1번 차분한 결과가 정상성 시계열 ARMA(1,0) 모형으로 나타남
#(p,d,q) d=0이면 ARMA(p,q)모형, 정상성 만족
#(p,d,q) p=0이면 IMA(d,q)모형,d번 차분하면 MA(p)모형을 따른다
#(p,d,q) q=0이면 ARI(p,d)모형, 정상성 만족, d번차분하면 AR(p)모형으 따른다.

Coefficients:
          ar1
      -0.6891
s.e.   0.2451

sigma^2 estimated as 31644:  log likelihood=-72.4
AIC=148.8 #모형에 대한 적합도(값이 적어야 채택)   AICc=150.3   BIC=149.59

> #  모형 생성 
> model <- arima(tsdata, order=c(1, 1, 0))
> model 

Call:
arima(x = tsdata, order = c(1, 1, 0))

Coefficients:
          ar1
      -0.6891
s.e.   0.2451

sigma^2 estimated as 28767:  log likelihood = -72.4,  aic = 148.8
```

aws

ID : lab07 

PW : multilab07!

